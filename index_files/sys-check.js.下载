(function(base_name){if(typeof window[base_name]!='undefined')return;var FUNCTIONS={};var CONTROLLERS={};var KW_TPL_STORE={};var me={};var define=function(name,cls,is_use){CONTROLLERS[name]=cls;is_use&&use(name)};var define_function=function(name,cls){var n=name.split('.');var a=n.pop();var c=n.join('.');(!FUNCTIONS[c])&&(FUNCTIONS[c]={});FUNCTIONS[c][a]=cls};var use=function(obj,succ){if(eval('typeof '+base_name+'["'+obj+'"]')=='undefined'){(!CONTROLLERS[obj])&&(CONTROLLERS[obj]=function(){});eval('var o='+base_name+'.'+obj+'= new CONTROLLERS["'+obj+'"]()');o['BASE']=me;(typeof o['__construct']=='function')&&o['__construct']();if(FUNCTIONS[obj]){for(var f in FUNCTIONS[obj]){eval('o["'+f+'"]=function(){'+'var ar=[];'+'for(var j=0;j<arguments.length;j++){ar.push(arguments[j]);}'+'ar.push( me );'+'return FUNCTIONS["'+obj+'"]["'+f+'"].apply(this,ar);'+'}')}}}(typeof succ=='function')&&succ(eval(base_name+'.'+obj))};var tpl=function(path,data,succ){if(!KW_TPL_STORE){KW_TPL_STORE={}}if(KW_TPL_STORE[path]){run(KW_TPL_STORE[path])}else{}function run(tpl_html){var html=_.template(tpl_html,$.extend({'BASE':me},(data?data:{})));(typeof succ=='function')&&succ.apply(null,[html])}};var set_tpl=function(k,v){KW_TPL_STORE[k]=v};var get=function(url,success,fail,opt){opt=opt||{};return $.ajax({url:url,success:function(data){(typeof success=='function')&&success(data,url)},error:function(message){(typeof fail=='function')&&fail(message,url)},complete:function(XMLHttpRequest,textStatus){},type:"get",timeout:opt.timeout||15000,dataType:opt.data_tpye||"json"})};var load=function(src,succ,fail){var id=base_name+"_load_js_"+$.md5(src);if(document.getElementById(id)){(typeof succ=='function')&&succ.call()}else{var s=document.createElement("script");s.id=id;s.type="text/javascript";s.onload=s.onreadystatechange=function(){if(s.readyState&&s.readyState!='loaded'&&s.readyState!='complete'){return}s.onreadystatechange=s.onload=null;(typeof succ=='function')&&succ.call()};s.onerror=function(){if(document.getElementById(id)){document.getElementById(id).parentNode.removeChild(document.getElementById(id))}if(typeof fail=='function'){fail()}};s.src=src;document.getElementsByTagName('HEAD').item(0).appendChild(s)}};var run=function(para){var c=para.c;var a=para.a;use(c,function(){window.scroll(0,0);var fun=eval(base_name+'.'+c+"."+a);fun.apply(null,[para])})};window[base_name]=me;me.name=base_name;me.define=define;me.define_function=define_function;me.use=use;me.tpl=tpl;me.set_tpl=set_tpl;me.get=get;me.load=load;me.run=run})('MO_sys_check');MO_sys_check.define('config',function(){this.test_speed_src='';this.src_size=0;this.is_new_win=false},true);MO_sys_check.define('data',function(){var me=this;this.cmd_server='';this.dom=null;this.version_name=''},true);MO_sys_check.bind=function(param){MO_sys_check.use('login_name',function(m){m.bind(param)})};MO_sys_check.open=function(test_speed_src,src_size,is_new_win){MO_sys_check.use('main',function(m){m.BASE.config.is_new_win=is_new_win;m.BASE.config.src_size=src_size;if(test_speed_src){m.BASE.config.test_speed_src=test_speed_src}else{m.BASE.config.test_speed_src=''}m.index()})};MO_sys_check.define('HTime',function(){var me=this;this.getTime=function(){var a=new Date();return a.getTime()}},true);MO_sys_check.define('HUrl',function(){var me=this;this.get_script_path=function(script){var src='';var path='';$('script').each(function(i,r){if($(this).attr('src')&&$(this).attr('src').indexOf(script)>=0){src=$(this).attr('src')}});if(src&&window.location.href.substr(0,4)=='http'){var a=document.createElement('a');a.href=src;path=a.pathname.replace(script,'');return path}else{return-1}}},true);MO_sys_check.define('login_name',function(){var me=this;this.dom_target='';this.on_select=function(){};this.on_delete=function(){};this.users=[];this.release_this_blur=false;this.id='login-history-name';this.__construct=function(){};this.bind=function(param){me.dom_target=param.dom;me.on_select=param.onSel;me.on_delete=param.onDel;me.users=param.users;me.BASE.tpl('login_name/list.tpl.html',{users:me.users},function(html){var $dom=$(html);$dom.css({left:me.dom_target.position().left});if(me.dom_target.css('margin-bottom')!='auto'){$dom.css({'margin-top':-1*parseInt(me.dom_target.css('margin-bottom'))})}$dom.css({width:me.dom_target.outerWidth()-2});me.dom_target.after($dom);$dom.mousedown(function(){me.release_this_blur=true});me.dom_target.focus(function(){me.show()});me.dom_target.keyup(function(){me.show()});$dom.find('.one').click(function(event){if(!$(event.target).hasClass('close')){$('#'+me.id).hide();me.on_select($(this).find('span').text())}});me.dom_target.blur(function(){setTimeout(function(){if(me.release_this_blur){me.release_this_blur=false}else{$('#'+me.id).hide()}},10)});$dom.find('.one .close').click(function(){me.release_this_blur=true;me.on_delete($(this).parents('.one').find('span').text());$(this).parents('.one').remove()})});$(document.body).mousedown(function(event){if(event.target==me.dom_target[0]||event.target==document.getElementById(me.id)||$(event.target).parents('#'+me.id).length){return}else{$('#'+me.id).hide()}})};this.show=function(){if($('#'+me.id+' .one').length){$('#'+me.id).show()}return;if($('#'+me.id+' .one').length){$('#'+me.id+' .one').hide();var v=me.dom_target.val();$.each($('#'+me.id+' .one >span'),function(i,r){if($(this).text().indexOf(v)==0){$(this).parent().show()}});$('#'+me.id).show()}}});MO_sys_check.define('main',function(){var me=this;this.test_flash_cmd_id='';this.__construct=function(){me.BASE.use('main.a');me.BASE.use('main.api');me.BASE.use('main.h')};this.index=function(){$('.sys-check').remove();try{if(('object'==typeof window.ebagShell)&&('function'==typeof window.ebagShell.closePageWindow)){}}catch(e){}me.BASE.tpl('main/index.tpl.html',{has_clear_function:('object'==typeof window.ebagShell)&&('function'==typeof window.ebagShell.clearCache)},function(html){var $dom=$(html);var $div=$dom.find('>div');$div.find('.sys-check-btn-net').eq(0).click(me.a.re_check);$div.find('.sys-check-btn-net').eq(1).click(me.close);$(document.body).append($dom);me.BASE.data.dom=$('.sys-check');me.a.re_check()})};this.close=function(){if(me.BASE.config.is_new_win){if(('object'==typeof window.ebagShell)&&('function'==typeof window.ebagShell.closePageWindow)){window.ebagShell.closePageWindow(window)}else{window.close()}}else{$('.sys-check').remove()}}});MO_sys_check.define_function('main.a.clear_cache',function(){var BASE=arguments[arguments.length-1];var me=BASE.main;BASE.data.dom.find('div[sys-check-clear-cache] >span').attr('class','sys-check-icon sys-check-icon-loading');setTimeout(function(){try{window.ebagShell.clearCache();window.ebagShell.removeCookies()}catch(e){alert(e)}BASE.data.dom.find('div[sys-check-clear-cache] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-well')},100)});MO_sys_check.define_function('main.a.re_check',function(){var BASE=arguments[arguments.length-1];var me=BASE.main;BASE.data.dom.find('div[sys-check-ping],div[sys-check-speed],div[sys-check-flash-play],div[sys-check-flash-setup]').find('>span').attr('class','sys-check-icon sys-check-icon-loading');BASE.data.dom.find('div[sys-check-ping],div[sys-check-speed],div[sys-check-flash-play],div[sys-check-flash-setup]').find(' h4>span').html('');BASE.data.dom.find('.sys-check-err').not('.sys-check-version').hide();me.api.cmd_ping(function(){BASE.data.dom.find('div[sys-check-ping] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-well');BASE.data.dom.find('div[sys-check-ping] h4>span').addClass('sys-check-normal').html('正常');(window.location.href.substr(0,4)!='http')&&test_flash(true)},function(){BASE.data.dom.find('div[sys-check-ping] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-irregular');BASE.data.dom.find('div[sys-check-ping] h4>span').removeClass('sys-check-normal').html('不正常');BASE.data.dom.find('div[sys-check-ping]').siblings('.sys-check-err').css('display','block')});(window.location.href.substr(0,4)=='http')&&test_flash();function test_flash(use_iframe){me.h.test_flash(use_iframe);var cmd_id=me.test_flash_cmd_id;setTimeout(function(){if(cmd_id==me.test_flash_cmd_id){if(!BASE.data.dom.find('div[sys-check-flash-play] >span').hasClass('sys-check-icon-well')){BASE.data.dom.find('div[sys-check-flash-play] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-irregular');BASE.data.dom.find('div[sys-check-flash-play] h4>span').removeClass('sys-check-normal').html('异常');BASE.data.dom.find('div[sys-check-flash-play]').siblings('.sys-check-err').css('display','block')}}},5000)}if(BASE.config.test_speed_src){var url=BASE.config.test_speed_src}else{BASE.config.src_size=221;var url=BASE.HUrl.get_script_path('sys-check.js')+'speed/speed-test-221.png'}me.h.test_src(url+'?'+me.BASE.HTime.getTime(),function(t){BASE.data.dom.find('div[sys-check-speed] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-well');console.log('pic-compute-size:'+BASE.config.src_size+'kb');BASE.data.dom.find('div[sys-check-speed] h4>span').addClass('sys-check-normal').html(t>0?Math.round(BASE.config.src_size*1000/t)+'kb/s':'')},function(){BASE.data.dom.find('div[sys-check-speed] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-irregular');BASE.data.dom.find('div[sys-check-speed] h4>span').removeClass('sys-check-normal').html('超时');BASE.data.dom.find('div[sys-check-speed]').siblings('.sys-check-err').css('display','block')},20000);if(me.h.detect_flash()){BASE.data.dom.find('div[sys-check-flash-setup] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-well');BASE.data.dom.find('div[sys-check-flash-setup] h4>span').addClass('sys-check-normal').html('已安装')}else{BASE.data.dom.find('div[sys-check-flash-setup] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-irregular');BASE.data.dom.find('div[sys-check-flash-setup] h4>span').removeClass('sys-check-normal').html('未安装');BASE.data.dom.find('div[sys-check-flash-setup]').siblings('.sys-check-err').css('display','block')}});MO_sys_check.define_function('main.api.cmd_ping',function(succ,fail){var BASE=arguments[arguments.length-1];BASE.data.cmd_server='';var li=['127.0.0.1:40080','127.0.0.1:40080','127.0.0.1:40080','127.0.0.1:40081','127.0.0.1:40082'];var test_num=1;test();function test(){BASE.get('http://'+li[test_num-1]+'/ping?info={}',function(d,api_url){if(d.status==1){BASE.data.version_name=d['recordset']['version_name'];BASE.data.dom.find('.sys-check-version').html('当前版本：'+BASE.data.version_name).css('display','block');BASE.data.cmd_server=li[test_num-1];succ()}else{if(test_num>=3){fail&&fail()}else{test_num++;test()}}},function(err,api_url){if(test_num>=3){fail&&fail()}else{test_num++;test()}},{timeout:1*1500})}});MO_sys_check.define_function('main.h.detect_flash',function(){if(navigator.mimeTypes.length>0){if(navigator.mimeTypes["application/x-shockwave-flash"]!=undefined){return navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin!=null}else{return false}}else if(window.ActiveXObject){try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash");return true}catch(oError){return false}}else{return false}});MO_sys_check.define_function('main.h.test_flash',function(use_iframe){var BASE=arguments[arguments.length-1];var me=BASE.main;me.test_flash_cmd_id=BASE.HTime.getTime();if(use_iframe){BASE.data.dom.find('iframe').remove();var url="http://"+BASE.data.cmd_server+"/ebag/chrome/content/iclass-html/e/sys-check/"+"iframe-flash.html?14c4b06b824ec593"+me.test_flash_cmd_id+"239362517f538b29";BASE.tpl('main/iframe-flash.tpl.html',{url:url},function(html){BASE.data.dom.find('>div').append(html)})}else{var url=BASE.HUrl.get_script_path('sys-check.js')+"flash/test-as.swf?callback=window."+BASE.name+".main.h.test_flash_callback('"+me.test_flash_cmd_id+"')";BASE.tpl('main/flash.tpl.html',{url:url},function(html){BASE.data.dom.find('>div').append(html)})}});MO_sys_check.define_function('main.h.test_flash_callback',function(code){var BASE=arguments[arguments.length-1];var me=BASE.main;if(code==me.test_flash_cmd_id){BASE.data.dom.find('div[sys-check-flash-play] >span').removeClass('sys-check-icon-loading').addClass('sys-check-icon-well');BASE.data.dom.find('div[sys-check-flash-play] h4>span').addClass('sys-check-normal').html('正常')}});MO_sys_check.define_function('main.h.test_src',function(src,succ,fail,max_time){var BASE=arguments[arguments.length-1];max_time=max_time||5000;var timer=null;var img=new Image();var start=BASE.HTime.getTime();img.onload=function(){img.onload=null;var end=BASE.HTime.getTime();succ(end-start)};img.onerror=function(){img.onerror=null;fail(1)};img.src=src+'?'+start;timer=setTimeout(function(){if(img.onload&&img.onerror){img.onload=null;img.onerror=null;fail(2)}img=null},max_time)});MO_sys_check.set_tpl('login_name/list.tpl.html','<div id="login-history-name"><%$.each(users,function(i,v){%><div class="one"><span><%=v%></span><a class="close"></a></div><%})%></div>');
MO_sys_check.set_tpl('main/flash.tpl.html','<div><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,29,0"width="950"height="600"><embed src="<%=url%>"quality="high"pluginspage="http://www.macromedia.com/go/getflashplayer"type="application/x-shockwave-flash"width="0"height="0"></embed></object></div>');
MO_sys_check.set_tpl('main/iframe-flash.tpl.html','<iframe src="<%=url%>"height="0"frameborder="0"></iframe>');
MO_sys_check.set_tpl('main/index.tpl.html','<div class="sys-check"><div><div><div><h1>&nbsp;&nbsp;&nbsp;&nbsp;系统检测</h1></div><span class="sys-check-err sys-check-version">当前版本：2.85</span></div><div><div sys-check-ping=\'1\'><span class="sys-check-icon sys-check-icon-irregular"></span><h4>与优学派电子书包服务器连接状况<span class="sys-check-status">不正常</span></h4></div><span class="sys-check-err"><p>电子书包系统需要启动指令服务器才能正常工作，请重启软件;<br>如未安装客户端，请到官网下载安装；</p></span></div><div style="margin-bottom:10px;"><div sys-check-speed=\'1\'><span class="sys-check-icon"></span><h4>检测网络速度<span class="sys-check-status">1kb/s</span></h4></div><span class="sys-check-err"><p>请检查网线口是否松动，是否连接可用的WIFI信号；<br>在浏览器打开http://www.anoah.com,看是否能够打开</p></span></div><div><div sys-check-flash-play=\'1\'><span class="sys-check-icon sys-check-icon-well"></span><h4>视频、FLASH播放器能否正常播放<span class="sys-check-status">正常/不正常</span></h4></div><span class="sys-check-err"><p>防火墙有可能屏蔽了播放视频功能，请检测防火墙设置</p></span></div><div><div sys-check-flash-setup=\'1\'><span class="sys-check-icon sys-check-icon-loading"></span><h4>检测是否安装Flash Player插件<span class="sys-check-status">已安装/未安装</span></h4></div><span class="sys-check-err"><p>点击下载最新安装包，然后重起系统</p></span><%if(!has_clear_function){%><div class="sys-check-btns"align="right"><a href="javascript:void(0);"class="sys-check-btn-net">重新检测</a><a href="javascript:void(0);"class="sys-check-btn-net">关闭</a></div><%}%></div><%if(has_clear_function){%><div><div sys-check-clear-cache=\'1\'><span class="sys-check-icon"></span><h4>清理电脑中的cookie、缓存<span class="sys-check-btn-green"onclick="<%=BASE.name%>.main.a.clear_cache();">一键清理</span></h4></div><div class="sys-check-btns"align="right"><a href="javascript:void(0);"class="sys-check-btn-net">重新检测</a><a href="javascript:void(0);"class="sys-check-btn-net">关闭</a></div></div><%}%></div></div>');
